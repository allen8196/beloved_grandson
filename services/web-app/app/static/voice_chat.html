<!DOCTYPE html>
<html lang="zh-Hant-TW">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>即時語音回覆</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <style>
    :root {
      --bg1: #D7ECF5;
      --bg2: #C1B8E6;
      --bg3: #6DA9E4;
      --overlay: rgba(255, 255, 255, .55);
      --text: #22374A;
      --hint: #A6A0E8;
      --label: #6D9BC3;
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      font-family: "Nunito Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      background: url("毛玻璃_BG2.png") center/cover no-repeat fixed;
      color: var(--text);
    }

    .bg-glass-overlay {
      position: fixed;
      inset: 0;
      background: var(--overlay);
      backdrop-filter: blur(12px)
    }

    .container {
      position: relative;
      max-width: 720px;
      margin: 0 auto;
      min-height: 100dvh;
      display: flex;
      flex-direction: column
    }

    header {
      position: relative;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: center
    }

    .brand {
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      gap: 8px
    }

    .brand img {
      box-sizing: border-box;
      width: 40%;
      margin-top: 80px;
    }

    .brand .name {
      font-weight: 700;
      color: #214053;
      font-size: 18px
    }

    main {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px
    }

    .stage {
      position: relative;
      width: min(76vw, 420px);
      height: min(76vw, 420px)
    }

    .circle {
      position: absolute;
      inset: 0;
      margin: auto;
      width: 48%;
      height: 48%;
      border-radius: 9999px;
      background: #fff;
      box-shadow: 0 8px 24px rgba(0, 0, 0, .12)
    }

    .wave {
      position: absolute;
      inset: 0;
      margin: auto;
      width: 60%;
      height: 60%;
      border-radius: 9999px;
      background: radial-gradient(closest-side, rgba(163, 213, 231, .6), rgba(163, 213, 231, 0));
      opacity: .6
    }

    .pulse {
      animation: pulse 1.5s ease-in-out infinite
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
        opacity: .6
      }

      70% {
        transform: scale(1.18);
        opacity: .15
      }

      100% {
        transform: scale(1.32);
        opacity: 0
      }
    }

    .overlay {
      position: absolute;
      left: 50%;
      top: -18%;
      transform: translateX(-50%);
      max-width: 92%;
      padding: .6rem .9rem;
      /* border-radius: 14px; */
      /* background: rgba(34, 55, 74, .22); */
      backdrop-filter: blur(8px);
      color: #ABB1E5;
      font-size: 24px;
      font-weight: 600;
      line-height: 1.5;
      text-align: center
    }

    .dots {
      display: inline-flex;
      gap: 6px;
      align-items: center
    }

    .dots span {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #fff;
      opacity: .85;
      animation: dot 1.2s infinite
    }

    .dots span:nth-child(2) {
      animation-delay: .2s
    }

    .dots span:nth-child(3) {
      animation-delay: .4s
    }

    @keyframes dot {

      0%,
      100% {
        transform: translateY(0);
        opacity: .45
      }

      50% {
        transform: translateY(-4px);
        opacity: 1
      }
    }

    .cursor::after {
      content: "▋";
      animation: blink 1s step-end infinite
    }

    @keyframes blink {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: 0
      }
    }

    /* Raise the control area like ChatGPT voice UI */
    footer {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 120px;
      padding: 0 16px
    }

    .controls {
      max-width: 720px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px
    }

    .btn {
      position: relative;
      width: min(22vw, 92px);
      height: min(22vw, 92px);
      border-radius: 9999px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      border: 1px solid rgba(255, 255, 255, .35);
      background: linear-gradient(145deg, rgba(125, 226, 255, .65), rgba(74, 196, 250, .45));
      box-shadow: 0 10px 30px rgba(92, 214, 254, .35), inset 0 1px 10px rgba(255, 255, 255, .45);
      backdrop-filter: blur(12px);
      cursor: pointer;
      transition: transform .18s ease, box-shadow .18s ease
    }

    .btn:active {
      transform: scale(.96);
      box-shadow: 0 6px 20px rgba(92, 214, 254, .5), inset 0 1px 8px rgba(255, 255, 255, .55)
    }

    .label {
      font-size: 18px;
      color: var(--label);
      font-weight: 600
    }

    /* idle arrows */
    .arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      color: #fff;
      opacity: .6;
      animation: hint 1.2s ease-in-out infinite
    }

    .arrow.left {
      left: -42px
    }

    .arrow.right {
      right: -42px;
      animation-delay: .6s
    }

    @keyframes hint {

      0%,
      100% {
        opacity: .2;
        transform: translateY(-50%) translateX(0)
      }

      50% {
        opacity: .9;
        transform: translateY(-50%) translateX(6px)
      }
    }

    /* accessibility: larger base sizes */
    @media (min-width: 480px) {
      .overlay {
        font-size: 19px
      }

      .label {
        font-size: 19px
      }
    }
  </style>
</head>

<body>
  <div class="bg-glass-overlay"></div>
  <div id="root" class="container"></div>

  <script src="https://unpkg.com/preact@10.20.2/dist/preact.umd.js"></script>
  <script src="https://unpkg.com/preact@10.20.2/hooks/dist/hooks.umd.js"></script>
  <script src="https://unpkg.com/htm@3.1.1/dist/htm.umd.js"></script>
  <script>
    const { h, render } = preact; const { useState, useRef } = preactHooks; const html = htm.bind(h)

    function Dots() { return html`<span class="dots"><span></span><span></span><span></span></span>` }

    function useAudioUnlock() {
      const unlockedRef = useRef(false)
      const unlock = () => {
        if (unlockedRef.current) return
        try { const AC = window.AudioContext || window.webkitAudioContext; const ctx = new AC(); const o = ctx.createOscillator(); const g = ctx.createGain(); g.gain.value = 0; o.connect(g); g.connect(ctx.destination); o.start(0); o.stop(0); unlockedRef.current = true; setTimeout(() => ctx.close(), 0) } catch (e) { }
      }
      return { unlock }
    }

    function App() {
      const [overlay, setOverlay] = useState('')
      const [processing, setProcessing] = useState(false)
      const [speaking, setSpeaking] = useState(false)
      const mediaRef = useRef({ mediaRecorder: null, chunks: [], stream: null, audio: null })
      const { unlock } = useAudioUnlock()
      const PLACEHOLDER = '今天想跟艾莉分享什麼呢？'

      function showLoading() { setOverlay(html`<${Dots}/>`) }
      function typeText(text) {
        let i = 0; setOverlay('');
        (function step() {
          setOverlay(prev => `${typeof prev === 'string' ? prev : ''}${text.slice(i, i += Math.max(2, Math.floor(Math.random() * 4)))}`)
          if (i < text.length) setTimeout(step, 35)
        })()
      }

      async function safePlay(url) {
        const ref = mediaRef.current
        try {
          if (ref.audio) { ref.audio.pause(); ref.audio = null }
          ref.audio = new Audio(url); ref.audio.setAttribute('playsinline', '')
          ref.audio.onended = () => setSpeaking(false)
          await ref.audio.play()
        } catch (err) {
          setOverlay('點一下播放')
          const box = document.getElementById('overlay-box')
          const handler = async () => { try { await ref.audio.play(); setOverlay(''); box.removeEventListener('click', handler) } catch (e) { } }
          box.addEventListener('click', handler)
        }
      }

      async function start() {
        if (speaking) return
        unlock();
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true })
          const mime = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus' : undefined
          const mr = new MediaRecorder(stream, mime ? { mimeType: mime } : undefined)
          mediaRef.current = { mediaRecorder: mr, chunks: [], stream, audio: null }
          setProcessing(false); showLoading(); // show dots when starting
          mr.ondataavailable = e => { if (e.data.size > 0) mediaRef.current.chunks.push(e.data) }
          mr.onstop = async () => {
            setProcessing(true); setOverlay(html`<${Dots}/>`); const type = mime || 'audio/wav'; const blob = new Blob(mediaRef.current.chunks, { type })
            try {
              const fd = new FormData(); fd.append('audio', blob, 'voice.webm'); fd.append('patient_id', 'demo_user')
              const res = await fetch('/api/v1/voice/chat', { method: 'POST', body: fd })
              if (!res.ok) throw new Error('voice chat failed')
              const data = await res.json(); setProcessing(false)
              if (data.ai_response_text) { typeText(data.ai_response_text) }
              if (data.ai_audio_url) { setSpeaking(true); await safePlay(data.ai_audio_url) }
            } catch (err) { setProcessing(false); setOverlay('處理失敗，請重試') }
            // cleanup
            mediaRef.current.stream?.getTracks().forEach(t => t.stop())
          }
          mr.start();
          mediaRef.current.mediaRecorder = mr
        } catch (e) { alert('請允許麥克風權限以使用語音功能。') }
      }

      function stop() { const { mediaRecorder } = mediaRef.current; if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop() }

      return html`
          <header>
            <div class="brand"><img src="logo demo3.png" alt="RespiraAlly" /><span class="name"></span></div>
          </header>
          <main>
            <div class="stage">
              <div class=${`wave ${processing || speaking ? 'pulse' : ''}`}></div>
              <div class="circle"></div>
              <div id="overlay-box" class="overlay">${processing ? html`<${Dots}/>` : (overlay || PLACEHOLDER)}</div>
            </div>
          </main>
          <footer>
            <div class="controls" style="position:relative;display:flex;align-items:center;justify-content:center;">
              <span class="material-icons arrow left">chevron_right</span>
              <button class="btn" onMouseDown=${start} onMouseUp=${stop} onTouchStart=${(e) => { e.preventDefault(); start() }} onTouchEnd=${(e) => { e.preventDefault(); stop() }} aria-label="按住說話">
                <span class="material-icons" style="font-size:38px">mic</span>
              </button>
              <span class="material-icons arrow right">chevron_left</span>
            </div>
            <div class="controls"><div class="label">按住說話</div></div>
          </footer>
        `
    }

    render(h(App, {}), document.getElementById('root'))
  </script>
</body>

</html>
<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>mMRCå‘¼å¸å›°é›£é‡è¡¨</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
      body {
        font-family: Arial, "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
        color: #333;
        font-size: 20px;
        line-height: 1.5;
        transition: background-color 0.3s, color 0.3s;
      }

      .container {
        max-width: 100%;
        margin: 0 auto;
        padding: 15px;
        background-color: #fff;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        transition: background-color 0.3s, border 0.3s;
      }

      h2 {
        font-size: 28px;
        color: #28a745;
        text-align: center;
        margin-bottom: 25px;
        font-weight: bold;
        padding: 10px 0;
        border-bottom: 2px solid #eaeaea;
        transition: color 0.3s, border-bottom-color 0.3s;
      }

      .instruction {
        background-color: #e7f3ff;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        font-size: 18px;
        border-left: 4px solid #28a745;
        transition: background-color 0.3s;
      }

      #options {
        list-style-type: none;
        padding: 0;
        margin: 0;
      }

      #options li {
        margin-bottom: 15px;
      }

      button {
        width: 100%;
        padding: 20px 15px;
        font-size: 22px;
        border: none;
        border-radius: 10px;
        background-color: #f0f7ff;
        color: #333;
        text-align: left;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        display: flex;
        align-items: flex-start;
        line-height: 1.4;
      }

      button:hover,
      button:focus {
        background-color: #d4e6ff;
        transform: translateY(-2px);
      }

      button:active {
        transform: translateY(0);
      }

      .score {
        font-size: 32px;
        font-weight: bold;
        margin-right: 15px;
        color: #28a745;
        min-width: 50px;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #e8f5e8;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        flex-shrink: 0;
      }

      .description {
        flex: 1;
        padding-left: 10px;
      }

      .helper-text {
        text-align: center;
        margin-top: 20px;
        font-size: 18px;
        color: #666;
        transition: color 0.3s;
      }

      .contrast-toggle {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #ddd;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      body.high-contrast {
        background-color: #000;
        color: #fff;
      }

      body.high-contrast .container {
        background-color: #000;
        border: 2px solid #fff;
      }

      body.high-contrast h2 {
        color: #ffff00;
        border-bottom-color: #fff;
      }

      body.high-contrast .instruction {
        background-color: #333;
        color: #fff;
        border-left-color: #ffff00;
      }

      body.high-contrast button {
        background-color: #000;
        color: #fff;
        border: 2px solid #fff;
      }

      body.high-contrast .score {
        background-color: #333;
        color: #ffff00;
      }

      body.high-contrast .helper-text {
        color: #fff;
      }

      body.high-contrast button:hover,
      body.high-contrast button:focus {
        background-color: #333;
      }

      #loading-text {
        display: none;
        color: #28a745;
        text-align: center;
        font-size: 20px;
        margin-top: 10px;
        transition: color 0.3s;
      }

      body.high-contrast #loading-text {
        color: #ffff00;
      }

      @media screen and (max-width: 480px) {
        body {
          font-size: 24px;
        }

        button {
          font-size: 26px;
        }

        .score {
          font-size: 28px;
          width: 45px;
          height: 45px;
        }
      }
    </style>
  </head>

  <body>
    <button
      class="contrast-toggle"
      onclick="toggleContrast()"
      aria-label="åˆ‡æ›é«˜å°æ¯”åº¦æ¨¡å¼"
    >
      ğŸ‘ï¸
    </button>
    <div class="container" role="main">
      <h2 id="questionText">mMRCå‘¼å¸å›°é›£é‡è¡¨</h2>
      <div class="instruction">è«‹é¸æ“‡æœ€ç¬¦åˆæ‚¨ç›®å‰å‘¼å¸å›°é›£ç¨‹åº¦çš„é¸é …ï¼š</div>
      <ul id="options" role="list"></ul>
      <p id="loading-text">æ­£åœ¨æäº¤ä¸­ï¼Œè«‹ç¨å€™...</p>
      <p class="helper-text">è«‹é»é¸æœ€ç¬¦åˆæ‚¨æƒ…æ³çš„é¸é …</p>
    </div>
    <script>
      const mmrcOptions = [
        {
          score: 0,
          description: "é™¤éåŠ‡çƒˆé‹å‹•ï¼Œå¦å‰‡ä¸æœƒæ„Ÿåˆ°å‘¼å¸å›°é›£",
        },
        {
          score: 1,
          description: "å¿«æ­¥è¡Œèµ°æˆ–èµ°å°å¡æ™‚æœƒæ„Ÿåˆ°å‘¼å¸å›°é›£",
        },
        {
          score: 2,
          description:
            "ç”±æ–¼å‘¼å¸å›°é›£ï¼Œåœ¨å¹³åœ°è¡Œèµ°æ™‚æ¯”åŒå¹´é½¡çš„äººæ…¢ï¼Œæˆ–è€…ä»¥è‡ªå·±çš„æ­¥èª¿åœ¨å¹³åœ°è¡Œèµ°æ™‚éœ€è¦åœä¸‹ä¾†å‘¼å¸",
        },
        {
          score: 3,
          description:
            "åœ¨å¹³åœ°è¡Œèµ°ç´„100å…¬å°ºæˆ–å¹¾åˆ†é˜å¾Œï¼Œå› å‘¼å¸å›°é›£è€Œéœ€è¦åœä¸‹ä¾†å‘¼å¸",
        },
        {
          score: 4,
          description:
            "å› åš´é‡å‘¼å¸å›°é›£è€Œç„¡æ³•é›¢é–‹å®¶ï¼Œæˆ–åœ¨ç©¿è„«è¡£æœæ™‚æœƒæ„Ÿåˆ°å‘¼å¸å›°é›£",
        },
      ];

      let userId = "unknown_user";
      let patientId = null;
      let accessToken = null;
      let authenticationFailed = false;
      const LIFF_ID = "ä½ çš„LIFF_ID"; // è«‹æ›¿æ›ç‚ºå¯¦éš›çš„ LIFF ID

      async function main() {
        try {
          await liff.init({ liffId: LIFF_ID });
          if (!liff.isLoggedIn()) {
            liff.login();
            return;
          }

          const context = liff.getContext();
          if (context && context.userId) {
            userId = context.userId;
            // ç²å– LIFF access token
            accessToken = liff.getAccessToken();

            // å˜—è©¦ç²å– patient_id å’Œèªè­‰
            try {
              await authenticateAndGetPatientId();
            } catch (authError) {
              console.error("èªè­‰å¤±æ•—:", authError);
              authenticationFailed = true;
              alert(
                "èªè­‰å¤±æ•—ï¼Œå•å·æ•¸æ“šå°‡ç„¡æ³•å„²å­˜åˆ°æ‚¨çš„å¸³æˆ¶ä¸­ï¼Œä½†æ‚¨ä»å¯ç¹¼çºŒå¡«å¯«å•å·ã€‚"
              );
            }
          } else {
            authenticationFailed = true;
            alert(
              "ç„¡æ³•ç²å–ç”¨æˆ¶è³‡è¨Šï¼Œå•å·æ•¸æ“šå°‡ç„¡æ³•å„²å­˜ï¼Œä½†æ‚¨ä»å¯ç¹¼çºŒå¡«å¯«å•å·ã€‚"
            );
          }

          renderQuestion();
          checkSavedContrast();
        } catch (err) {
          console.error("LIFF åˆå§‹åŒ–å¤±æ•—:", err);
          authenticationFailed = true;
          alert("LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œå•å·æ•¸æ“šå°‡ç„¡æ³•å„²å­˜ï¼Œä½†æ‚¨ä»å¯ç¹¼çºŒå¡«å¯«å•å·ã€‚");
          // ç¹¼çºŒæ¸²æŸ“å•é¡Œï¼Œå³ä½¿LIFFå¤±æ•—ä¹Ÿèƒ½ä½¿ç”¨
          renderQuestion();
          checkSavedContrast();
        }
      }

      // æ–°å¢ï¼šèªè­‰ä¸¦ç²å– patient_id çš„å‡½æ•¸
      async function authenticateAndGetPatientId() {
        try {
          const response = await fetch("/api/auth/line/login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ lineUserId: userId }),
          });

          if (response.ok) {
            const data = await response.json();
            patientId = data.user.id;
            accessToken = data.access_token; // ä½¿ç”¨å¾Œç«¯è¿”å›çš„ JWT token
            console.log("èªè­‰æˆåŠŸï¼ŒPatient ID:", patientId);
          } else {
            throw new Error(`èªè­‰è«‹æ±‚å¤±æ•—: ${response.status}`);
          }
        } catch (error) {
          console.error("èªè­‰éç¨‹ç™¼ç”ŸéŒ¯èª¤:", error);
          throw error;
        }
      }

      function renderQuestion() {
        const list = document.getElementById("options");
        list.innerHTML = "";

        mmrcOptions.forEach((option, index) => {
          const li = document.createElement("li");
          li.setAttribute("role", "listitem");

          const button = document.createElement("button");
          button.onclick = () => submitScore(option.score);
          button.tabIndex = 0;
          button.setAttribute(
            "aria-label",
            `ç­‰ç´š${option.score}ï¼š${option.description}`
          );

          const scoreElement = document.createElement("div");
          scoreElement.className = "score";
          scoreElement.textContent = option.score;

          const descriptionElement = document.createElement("div");
          descriptionElement.className = "description";
          descriptionElement.textContent = option.description;

          button.appendChild(scoreElement);
          button.appendChild(descriptionElement);

          li.appendChild(button);
          list.appendChild(li);
        });

        // è®€å‡ºå•é¡Œ
        speak("è«‹é¸æ“‡æœ€ç¬¦åˆæ‚¨ç›®å‰å‘¼å¸å›°é›£ç¨‹åº¦çš„é¸é …");
      }

      function speak(text) {
        if (!("speechSynthesis" in window)) return;

        const synth = window.speechSynthesis;
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = "zh-TW"; // ä½¿ç”¨å°ç£ä¸­æ–‡

        // å–æ¶ˆä»»ä½•æ­£åœ¨é€²è¡Œçš„èªéŸ³
        synth.cancel();

        // ç²å–æ‰€æœ‰å¯ç”¨çš„èªéŸ³
        const voices = synth.getVoices();

        // å°‹æ‰¾ä¸­æ–‡èªéŸ³
        const chineseVoice = voices.find(
          (voice) => voice.lang.includes("zh-TW") || voice.lang.includes("cmn")
        );

        if (chineseVoice) {
          utter.voice = chineseVoice;
        }

        // æ’­æ”¾èªéŸ³
        synth.speak(utter);
      }

      async function submitScore(mmrcScore) {
        showLoading(true);

        if (authenticationFailed || !patientId || !accessToken) {
          alert(
            "ç”±æ–¼èªè­‰å¤±æ•—ï¼ŒmMRCå•å·æ•¸æ“šç„¡æ³•å„²å­˜åˆ°æ‚¨çš„å¸³æˆ¶ï¼Œä½†å°‡ç¹¼çºŒå®Œæˆæµç¨‹ã€‚"
          );
          showLoading(false);
          if (typeof liff !== "undefined" && liff.isInClient()) {
            liff.closeWindow();
          } else {
            window.location.href = "thankyou.html";
          }
          return;
        }

        try {
          const payload = {
            record_date: new Date().toISOString().split("T")[0], // YYYY-MM-DD æ ¼å¼
            score: mmrcScore,
            answer_text: mmrcOptions[mmrcScore].description, // ç²å–å°æ‡‰çš„æ–‡å­—æè¿°
          };

          const response = await fetch(
            `/api/v1/patients/${patientId}/questionnaires/mmrc`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${accessToken}`,
              },
              body: JSON.stringify(payload),
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              `æäº¤å¤±æ•—: ${response.status} - ${
                errorData.error?.message || "Unknown error"
              }`
            );
          }

          const result = await response.json();
          console.log("mMRC å•å·æäº¤æˆåŠŸ:", result);
          alert("mMRCå•å·æäº¤æˆåŠŸï¼");
        } catch (error) {
          console.error("mMRCæäº¤å¤±æ•—:", error);
          alert(`mMRCå•å·æäº¤å¤±æ•—: ${error.message}ï¼Œä½†å°‡ç¹¼çºŒå®Œæˆæµç¨‹`);
        }

        // ç„¡è«–æäº¤æˆåŠŸæˆ–å¤±æ•—ï¼Œéƒ½ç¹¼çºŒé€²è¡Œæµç¨‹
        showLoading(false);
        if (typeof liff !== "undefined" && liff.isInClient()) {
          liff.closeWindow();
        } else {
          window.location.href = "thankyou.html";
        }
      }

      function showLoading(show) {
        document.getElementById("loading-text").style.display = show
          ? "block"
          : "none";
      }

      function toggleContrast() {
        document.body.classList.toggle("high-contrast");
        const isHighContrast =
          document.body.classList.contains("high-contrast");
        localStorage.setItem("highContrast", isHighContrast);
      }

      function checkSavedContrast() {
        const isHighContrast = localStorage.getItem("highContrast") === "true";
        if (isHighContrast) {
          document.body.classList.add("high-contrast");
        }
      }

      // ç¢ºä¿èªéŸ³å¼•æ“å·²åŠ è¼‰
      function loadVoices() {
        return new Promise((resolve) => {
          const synth = window.speechSynthesis;
          let voices = synth.getVoices();

          if (voices.length > 0) {
            resolve(voices);
            return;
          }

          // å¦‚æœèªéŸ³å°šæœªåŠ è¼‰ï¼Œç­‰å¾…voiceschangedäº‹ä»¶
          synth.onvoiceschanged = () => {
            voices = synth.getVoices();
            resolve(voices);
          };
        });
      }

      // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", async () => {
        // å…ˆåŠ è¼‰èªéŸ³å¼•æ“
        await loadVoices();
        main();
      });
    </script>
  </body>
</html>
